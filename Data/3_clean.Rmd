---
title: "3_clean"
author: "Thomas E. Metherell"
date: "2022-12-06"
output: html_document
---

Script in series: "Associations between early life mental health indicators and sleep in adulthood"

This script cleans and pre-processes main survey data from the 1970 British Cohort Study, along with selected CLOSER harmonisation work packages, for use in further analysis.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Dependencies
We start by loading the necessary dependencies.

```{r dependencies}
library(haven)
library(tidyverse)
library(magrittr)
library(data.table)
```

## Loading data
We can now load the raw BCS70 and CLOSER data downloaded from the UK Data Service. Data in this project are handled in Stata (.dta) format.

```{r load_data}
# Reading DTA files containing BCS70 data from sweeps at birth, ages 5 (x3), 10 (x2), 16 (x4), 26, 30, 42 and 46
# Storing the contents of each as a separate data frame
birth <- read_dta("..\\..\\Data\\Raw\\1a_Birth_&_22_month\\UKDA-2666-stata9\\stata9\\bcs7072a.dta")
age_5d <- read_dta("..\\..\\Data\\Raw\\2_age_5\\UKDA-2699-stata\\stata\\stata11\\f699a.dta")
age_5e <- read_dta("..\\..\\Data\\Raw\\2_age_5\\UKDA-2699-stata\\stata\\stata11\\f699b.dta")
age_5f <- read_dta("..\\..\\Data\\Raw\\2_age_5\\UKDA-2699-stata\\stata\\stata11\\f699c.dta")
age_5dv <- read_dta("..\\..\\Data\\Raw\\2_age_5\\UKDA-2699-stata\\stata\\stata11\\bcs2derived.dta")
age_10 <- read_dta("..\\..\\Data\\Raw\\3_age_10\\UKDA-3723-stata\\stata\\stata11_se\\sn3723.dta")
age_10dv <- read_dta("..\\..\\Data\\Raw\\3_age_10\\UKDA-3723-stata\\stata\\stata11_se\\bcs3derived.dta")
age_16 <- read_dta("..\\..\\Data\\Raw\\4_age_16\\UKDA-3535-stata\\stata\\stata13_se\\bcs7016x.dta")
age_16arith <- read_dta("..\\..\\Data\\Raw\\4a_age_16_arithmetic\\UKDA-6095-stata\\stata\\stata11\\bcs70_16-year_arithmetic_data.dta")
age_16dv <- read_dta("..\\..\\Data\\Raw\\4_age_16\\UKDA-3535-stata\\stata\\stata13_se\\bcs4derived.dta")
age_16school <- read_dta("..\\..\\Data\\Raw\\4_age_16\\UKDA-3535-stata\\stata\\stata13_se\\bcs70_age16_school_type.dta")
age_26 <- read_dta("..\\..\\Data\\Raw\\5_age_26\\UKDA-3833-stata\\stata\\stata11\\bcs96x.dta")
age_30 <- read_dta("..\\..\\Data\\Raw\\6_age_30\\UKDA-5558-stata\\stata\\stata11_se\\bcs2000.dta")
age_42 <- read_dta("..\\..\\Data\\Raw\\9_age_42\\UKDA-7473-stata\\stata\\stata13\\bcs70_2012_flatfile.dta")
age_42dv <- read_dta("..\\..\\Data\\Raw\\9_age_42\\UKDA-7473-stata\\stata\\stata13\\bcs70_2012_derived.dta")
age_46 <- read_dta("..\\..\\Data\\Raw\\10_age_46\\UKDA-8547-stata\\stata\\stata11\\bcs_age46_main.dta")

# Reading DTA files containing data from CLOSER WPs 1, 2 and 9
# Storing the contents of each as a separate data frame
CLOSER_env <- read_dta("..\\..\\Data\\Raw\\CLOSER_childhood_environment_adult_wellbeing\\UKDA-8553-stata\\stata\\stata13\\bcs70_closer_wp9.dta")
CLOSER_BMI <- read_dta("..\\..\\Data\\Raw\\CLOSER_height_weight_BMI\\UKDA-8551-stata\\stata\\stata13\\bcs70_closer_wp1.dta")
CLOSER_SES <- read_dta("..\\..\\Data\\Raw\\CLOSER_socioeconomic_measures\\UKDA-8305-stata\\stata\\stata13\\bcs70_closer_wp2ses.dta")

# Reading DTA file of response dataset and storing the contents as a data frame
response <- read_dta("..\\..\\Data\\Raw\\Response_dataset\\UKDA-5641-stata\\stata\\stata13\\bcs70_response_1970-2016.dta")

# Reading derived sleep data files and storing contents of each as a data frame
activpal <- fread("..\\..\\Data\\Raw\\10b_age_46_sleep_data\\activpal_sleep_bcsid.csv")
diary <- read_sav("..\\..\\Data\\Raw\\10b_age_46_sleep_data\\diary_cleaned_bcsid.sav")
vdb <- fread("..\\..\\Data\\Raw\\10b_age_46_sleep_data\\vanderberg_sleep_bcsid.csv")
winkler <- fread("..\\..\\Data\\Raw\\10b_age_46_sleep_data\\winkler_sleep_bcsid.csv")
```

## Selecting relevant variables
We now select the variables relevant to our analyses (see study protocol), discarding the unnecessary data. Asterisks (*) mark auxiliary variables.

```{r select_vars}
# Birth sweep data
birth %<>% select(
  bcsid, # BCS70 serial number
  a0005a, # Maternal age at birth
  a0009, # Mother's age at completion of education
  a0010, # Father's age at completion of education
  a0014, # Social class of father in 1970
  a0043b, # Smoking during pregnancy
  a0195a, # Gestational age in days
  a0230, # Occurrence of genital tract bleeding*
  a0255, # Sex of the baby*
  a0278 # Birthweight
)

# Age 5 sweep data (D)
age_5d %<>% select(
  bcsid, # BCS70 serial number
  d016a, # Bedwetting
  d119 # Rutter score
)

# Age 5 sweep data (E)
age_5e %<>% select(
  bcsid, # BCS70 serial number
  e067:e076, # Medical conditions
  e192, # Age father left school*
  e197, # Father's social class
  e206, # Mother's social class
  e216a, # Mother's regular job since child's birth
)

# Age 5 sweep data (F)
age_5f %<>% select(
  bcsid, # BCS70 serial number
  f100, # Schonell Reading Test score
  f118, # Complete a Profile Test score
  f121, # Standardised Human Figure Drawing score
  f122 # Standardised Copying Designs score
)

# Renaming "BCSID" to "bcsid" in age_5dv for consistency
age_5dv %<>% rename(bcsid = BCSID)

# Age 5 derived variables
age_5dv %<>% select(
  bcsid, # BCS70 serial number
  BD2READ # Standardised English Picture Vocabulary Test score
)

# Age 10 sweep data
age_10 %<>% select(
  bcsid, # BCS70 serial number
  i3504:i3540, # BAS word definitions
  i3541:i3574, # BAS recall of digits
  i3617:i3644, # BAS matrices
  i4201:i4221, # BAS word similarities (derived)
  j111, # Total days missed schooling*
  j127:j178b, # Child Development Scale
  m84:m101, # Positive activities outside school*
  meb4_1, meb4_6, meb4_16, meb4_21, meb4_26, meb4_46, meb4_51, # Medical conditions (present)
  meb4_2:meb4_4, meb4_7:meb4_9, meb4_17:meb4_19, meb4_22:meb4_24, meb4_27:meb4_29, meb4_47:meb4_49, meb4_52:meb4_54, # Medical conditions (absent)
  tests10 # Maths test, reading test, BAS test completed
)

# Renaming "BCSID" to "bcsid" in age_10dv for consistency
age_10dv %<>% rename(bcsid = BCSID)

# Age 10 derived variables
age_10dv %<>% select(
  bcsid, # BCS70 serial number
  BD3MRUTT # Rutter score
)

# Age 16 sweep data
age_16 %<>% select(
  bcsid, # BCS70 serial number
  contains("hd5_"), # Alcohol in last 7 days*
  contains("oe1_"), # Sources of income*
  rd6m_1, # Behavioural or emotional problems
  t11_2, # Father's social class
  t11_9 # Mother's social class
)

# Age 16 arithmetic test data
age_16arith %<>% select(
  bcsid, # BCS70 serial number
  mathscore # Arithmetic test score*
)

# Renaming "BCSID" to "bcsid" in age_16dv for consistency
age_16dv %<>% rename(bcsid = BCSID)

# Age 16 derived variables
age_16dv %<>% select(
  bcsid, # BCS70 serial number
  BD4MAL, # Total Malaise score
)

# Renaming "BCSID" to "bcsid" in age_16school for consistency
age_16school %<>% rename(bcsid = BCSID)

# Age 26 sweep data
age_26 %<>% select(
  bcsid, # BCS70 serial number
  b960539, b960540 # Accidents and assaults*
)

# Age 30 sweep data
age_30 %<>% select(
  bcsid, # BCS70 serial number
  aptrain, # Apprenticeships*
  emosup, # People for advice/support*
  hospital, numadmn, # Hospital admissions*
  wrktrain, # Work-related training*
  vote97 # Voted in 1997 General Election*
)

# Renaming "BCSID" to "bcsid" in age_42 and age_42dv for consistency
age_42 %<>% rename(bcsid = BCSID)
age_42dv %<>% rename(bcsid = BCSID)

# Age 42 sweep data
age_42 %<>% select(
  bcsid, # BCS70 serial number
  B9DIVCHK, B9HMS, B9MARCHK, # Marital status*
  contains("B9SCQ8"), # Organisational membership*
  B9SCQ17, # Computer ownership*
  B9SCQ19, # Number of cars or vans owned*
  B9TEN, # Housing tenure*
)

# Age 42 derived variables
age_42dv %<>% select(
  bcsid, # BCS70 serial number
  BD9MAL, # Malaise score
  BD9WEMWB # Warwick Edinburgh Mental Well-Being Scale
)

# Renaming "BCSID" to "bcsid" in age_46 for consistency
age_46 %<>% rename(bcsid = BCSID)

# Age 46 sweep data
age_46 %<>% select(
  bcsid, # BCS70 serial number
  B10HSLEEP # Average number of hours of sleep per night
)

# CLOSER WP9 data
CLOSER_env %<>% select(
  bcsid, # BCS70 serial number
  ameni, # Lacking sole use of amenities
  brfed, # Whether breastfed
  crowd, # Crowding in childhood
  divorce, # Parents divorced during study member's childhood
  extbcsz, # Externalising behaviour in childhood, standardised
  intbcsz, # Internalising behaviour in childhood, standardised
  prmnh, # Poor maternal / familial mental health
  resmove, # Number of residential moves in childhood
  sepmumbcs, # Ever separated from mother
  tenure # Accommodation owned or rented in childhood
)

# Restricting CLOSER WP1 data to those collected at age 10 only
CLOSER_BMI <- CLOSER_BMI[CLOSER_BMI$visitage == 10,]

# CLOSER WP1 data
CLOSER_BMI %<>% select(
  bcsid, # BCS70 serial number
  bmi # Body mass index
)

# CLOSER WP2 data
CLOSER_SES %<>% select(
  bcsid, # BCS70 serial number
  fclrg90 # Father's social class (RG 1990 version) at age 10 sweep
)

# Renaming "BCSID" to "bcsid" in response for consistency
response %<>% rename(bcsid = BCSID)

# Response dataset
response %<>% select(
  bcsid, # BCS70 serial number
  contains("OUTCME") # Outcome variables
)

# Renaming "BCSID" to "bcsid" in sleep variable datasets for consistency
activpal %<>% rename(bcsid = BCSID)
diary %<>% rename(bcsid = BCSID)
vdb %<>% rename(bcsid = BCSID)
winkler %<>% rename(bcsid = BCSID)

# Sleep diary
diary %<>% select(
  bcsid,
  md_sd_sleepdur, # Median sleep duration
  md_sleeprate # Median sleep rating
)
```

## Defining NAs
In order to allow correct data analysis, we define data points which are not available as NA. Mostly these are negative values from the source datasets, but there are some exceptions.

```{r define_na}
# Birth dataset: negative values become NA
is.na(birth[,]) <- birth[,] < 0

# Age 5 datasets (D & E): negative values become NA
is.na(age_5d[,]) <- age_5d[,] < 0
is.na(age_5e[,]) <- age_5e[,] < 0

# Age 5 dataset (F, reading & profile tests): negative values become NA
is.na(age_5f[c("f100", "f118")]) <- age_5f[c("f100", "f118")] < 0

# Age 5 dataset (F, HFD & copying designs tests): -5 becomes NA
is.na(age_5f[c("f121", "f122")]) <- age_5f[c("f121", "f122")] == -5

# Age 5 dataset (derived): -1 becomes NA
is.na(age_5dv[,]) <- age_5dv[,] == -1

# Age 10 dataset (CDS, positive activities): negative values become NA
is.na(age_10[, grep("j127", names(age_10)):grep("j178b", names(age_10))]) <- age_10[, grep("j127", names(age_10)):grep("j178b", names(age_10))] < 0
is.na(age_10[, grep("m84", names(age_10)):grep("m101", names(age_10))]) <- age_10[, grep("m84", names(age_10)):grep("m101", names(age_10))] < 0

# Age 10 derived variables dataset: negative values become NA
is.na(age_10dv[,]) <- age_10dv[,] < 0

# Age 16 dataset: negative values become NA
is.na(age_16[,]) <- age_16[,] < 0

# Age 16 derived variables dataset: negative values become NA
is.na(age_16dv[,]) <- age_16dv[,] < 0

# Age 16 school type dataset: negative values become NA
is.na(age_16school[,]) <- age_16school[,] < 0

# Age 26 dataset: negative values become NA
is.na(age_26[,]) <- age_26[,] < 0

# Age 30 dataset (hospital admissions only): 99 becomes NA
is.na(age_30[, "numadmn"]) <- age_30[, "numadmn"] == 99

# Age 30 dataset (all other variables): values above 7 become NA
is.na(age_30[c("aptrain", "wrktrain", "emosup", "hospital", "vote97")]) <- age_30[c("aptrain", "wrktrain", "emosup", "hospital", "vote97")] > 7

# Age 42 dataset: negative values become NA
is.na(age_42[,]) <- age_42[,] < 0

# Age 42 derived variables dataset: negative values become NA
is.na(age_42dv[,]) <- age_42dv[,] < 0

# Age 46 dataset: negative values become NA
is.na(age_46[,]) <- age_46[,] < 0

# CLOSER SES dataset: negative values become NA
is.na(CLOSER_SES[,]) <- CLOSER_SES[,] < 0

# CLOSER childhood environment dataset (all variables except internalising/externalising behaviour): negative values become NA
is.na(CLOSER_env[c("ameni", "brfed", "crowd", "divorce", "prmnh", "resmove", "sepmumbcs", "tenure")]) <- CLOSER_env[c("ameni", "brfed", "crowd", "divorce", "prmnh", "resmove", "sepmumbcs", "tenure")] < 0

# CLOSER childhood environment dataset (internalising/externalising behaviour): values less than -100 become NA
is.na(CLOSER_env[c("intbcsz", "extbcsz")]) <- CLOSER_env[c("intbcsz", "extbcsz")] < -100
```

## Cognitive ability - principal component analysis
In order to use cognitive ability as an exposure/confounder in our study, we need to convert the raw cognitive test scores into a univariate measure of cognitive ability. We do this by performing a principal component analysis (PCA), with the first component being the cognitive ability measure used in the study. This is performed at both age 5 and age 10.

```{r cognitive_ability_pca}
## Age 5
# Joining derived dataset (containing BD2READ) into dataset F and deleting the former
age_5f %<>% full_join(., age_5dv, by = "bcsid")
rm(age_5dv)

# Detecting missing values in rows
missing <- rowSums(is.na(age_5f)) != 0
age_5f <- data.frame(age_5f, missing)

# Performing principal component analysis
pca <- prcomp(age_5f[age_5f$missing == FALSE, c("BD2READ", "f100", "f118", "f121", "f122")], center = TRUE, scale. = TRUE)

# Initialising derived cognitive ability score variable
age_5f$dv_cog_abil_5 <- rep(NA, nrow(age_5f))

# Storing PCA first component as derived cognitive ability score
age_5f[age_5f$missing == FALSE,]$dv_cog_abil_5 <- pca[["x"]][, 1]

# Scaling the derived score to have mean 0 and SD 1
age_5f$dv_cog_abil_5 %<>% scale(.) %>% as.numeric(.)

# Removing cognitive ability other than the derived score
age_5f %<>% select(-BD2READ, -f100, -f118, -f121, -f122, -missing)

## Age 10
# Summing scores from the four BAS tests conducted, or reporting NA if the BAS were not completed
age_10 %<>% mutate(
  
  # Word Definitions
  dv_bas_worddef = case_when(
    tests10 == 1 ~ rowSums(across(i3504:i3540, `==`, 1)),
    tests10 == 0 ~ NA_real_
  ),
  
  # Recall of Digits
  dv_bas_recall = case_when(
    tests10 == 1 ~ rowSums(across(i3541:i3574, `==`, 1)),
    tests10 == 0 ~ NA_real_
  ),
  
  # Matrices
  dv_bas_matrices = case_when(
    tests10 == 1 ~ rowSums(across(i3617:i3644, `==`, 1)),
    tests10 == 0 ~ NA_real_
  ),
  
  # Word Similarities
  dv_bas_wordsim = case_when(
    tests10 == 1 ~ rowSums(across(i4201:i4221, `==`, 1)),
    tests10 == 0 ~ NA_real_
  )
)

# Performing principal component analysis
pca <- prcomp(age_10[age_10$tests10 == 1,] %>% select(contains("dv_bas")), center = TRUE, scale. = TRUE)

# Initialising derived cognitive ability score variable
age_10$dv_bas_g <- rep(NA, nrow(age_10))

# Storing PCA first component as derived cognitive ability score
age_10[age_10$tests10 == 1,]$dv_bas_g <- -pca[["x"]][, 1]

# Scaling the derived score to have mean 0 and SD 1
age_10$dv_bas_g %<>% scale(.) %>% as.numeric(.)

# Removing cognitive ability other than the derived score
age_10 %<>% select(
  -(contains("dv_bas") & !dv_bas_g),
  -(i3504:i4221),
  -tests10
)
```

## Merging the datasets
We can now merge the individual datasets into a single 'wide' dataset with one row per participant.

```{r merge_datasets}
# Initialising final dataset by copying over birth data
data_clean <- birth

# Joining each of the other datasets in turn to the final dataset using the BCS70 serial numbers of the participants
for(dataset in c("age_5d", "age_5e", "age_5f", "age_10", "age_10dv", "age_16", "age_16arith", "age_16dv", "age_16school", "age_26", "age_30", "age_42", "age_42dv", "age_46", "CLOSER_env", "CLOSER_BMI", "CLOSER_SES", "response", "activpal", "diary", "vdb", "winkler")){
  data_clean <- full_join(data_clean, get(dataset), by = "bcsid")
}

# Removing individual datasets
rm(list = c("birth", "age_5d", "age_5e", "age_5f", "age_10", "age_10dv", "age_16", "age_16arith", "age_16dv", "age_16school", "age_26", "age_30", "age_42", "age_42dv", "age_46", "CLOSER_env", "CLOSER_BMI", "CLOSER_SES", "response", "activpal", "diary", "vdb", "winkler"))
```

## Deriving exposure variables
To make the data useful, we produce a number of derived variables which are more informative than the raw source data. This applies to the exposures,...

```{r exposure_variables}
# Deriving total CDS score at age 10
data_clean %<>% mutate(j178a = 48 - j178a, j178b = 48 - j178b)
data_clean %<>% mutate(dv_cds_10 = rowSums(across(j127:j178b)))
data_clean %<>% select(-(j127:j178b))
```

## Deriving outcome variables
... the outcomes,...
```{r outcome_variables}
# Deriving abnormal sleep for each measure and removing raw variables
data_clean %<>% mutate(
  dv_sr_sleep_abn = case_when(
    B10HSLEEP < 6 | B10HSLEEP > 9 ~ 1,
    B10HSLEEP >= 6 & B10HSLEEP <= 9 ~ 0
  ),
  dv_sd_sleep_abn = case_when(
    md_sd_sleepdur < 360 | md_sd_sleepdur > 540 ~ 1,
    md_sd_sleepdur >= 360 & md_sd_sleepdur <= 540 ~ 0
  ),
  dv_pal_sleep_abn = case_when(
    md_pal_sleepdur < 21600 | md_pal_sleepdur > 32400 ~ 1,
    md_pal_sleepdur >= 21600 & md_pal_sleepdur <= 32400 ~ 0
  ),
  dv_vdb_sleep_abn = case_when(
    md_vdb_sleepdur < 21600 | md_vdb_sleepdur > 32400 ~ 1,
    md_vdb_sleepdur >= 21600 & md_vdb_sleepdur <= 32400 ~ 0
  ),
  dv_winkler_sleep_abn = case_when(
    md_winkler_sleepdur < 21600 | md_winkler_sleepdur > 32400 ~ 1,
    md_winkler_sleepdur >= 21600 & md_winkler_sleepdur <= 32400 ~ 0
  ),
  dv_sr_sleep_abn_cat = case_when(
    B10HSLEEP >= 6 & B10HSLEEP <= 9 ~ "Normal",
    B10HSLEEP < 6 ~ "Short",
    B10HSLEEP > 9 ~ "Long"
  ),
  dv_sd_sleep_abn_cat = case_when(
    md_sd_sleepdur >= 360 & md_sd_sleepdur <= 540 ~ "Normal",
    md_sd_sleepdur < 360 ~ "Short",
    md_sd_sleepdur > 540 ~ "Long"
  ),
  dv_pal_sleep_abn_cat = case_when(
    md_pal_sleepdur >= 21600 & md_pal_sleepdur <= 32400 ~ "Normal",
    md_pal_sleepdur < 21600 ~ "Short",
    md_pal_sleepdur > 32400 ~ "Long"
  ),
  dv_vdb_sleep_abn_cat = case_when(
    md_vdb_sleepdur >= 21600 & md_vdb_sleepdur <= 32400 ~ "Normal",
    md_vdb_sleepdur < 21600 ~ "Short",
    md_vdb_sleepdur > 32400 ~ "Long"
  ),
  dv_winkler_sleep_abn_cat = case_when(
    md_winkler_sleepdur >= 21600 & md_winkler_sleepdur <= 32400 ~ "Normal",
    md_winkler_sleepdur < 21600 ~ "Short",
    md_winkler_sleepdur > 32400 ~ "Long"
  )
)
data_clean %<>% select(-B10HSLEEP, -(contains("md_") & !contains("md_sleeprate")))
```

## Deriving control variables
... and the controls. Many variables also need to be recoded as factors.

```{r control_variables}
# Deriving maximum parental education at birth and removing individual variables
data_clean %<>% rowwise() %>% mutate(dv_par_edu_birth = max(a0009, a0010))
data_clean %<>% select(-a0009, -a0010)

# Recoding father's education as a binary factor variable for use as an auxiliary variable
data_clean %<>% mutate(dv_father_schl = case_when(
  e192 >= 16 ~ 1,
  e192 < 15 ~ 0
))
data_clean %<>% select(-e192)

# Deriving maximum parental social class at age 5 and removing individual variables
data_clean %<>% rowwise() %>% mutate(dv_sc_age_5 = min(e197, e206))
data_clean %<>% select(-e197, -e206)

# Combining age 5 medical condition variables into a single binary variable and removing individual variables
data_clean %<>% mutate(dv_med_5 = case_when(
  if_any(e067:e076, ~. == 1) ~ 1,
  if_all(e067:e076, ~. != 1) ~ 0
))
data_clean %<>% select(-(e067:e076))

# Combining age 10 medical condition variables into a single binary variable and removing individual variables
data_clean %<>% mutate(dv_med_10 = case_when(
  if_any(meb4_1:meb4_51, ~. == 1) ~ 1,
  if_all(meb4_1:meb4_51, ~ is.na(.)) & if_any(meb4_2:meb4_54, ~. == 1) ~ 0
))
data_clean %<>% select(-(meb4_1:meb4_51), -(meb4_2:meb4_54))

# Deriving maximum parental social class at age 16 and removing individual variables
data_clean %<>% rowwise() %>% mutate(dv_sc_age_16 = min(t11_2, t11_9))
data_clean %<>% select(-t11_2, -t11_9)

# Combining age 16 income source variables into a single variable (employment & investments vs other) and removing individual variables
data_clean %<>% mutate(dv_incsource = case_when(
  if_any(oe1_1:oe1_5, ~. == 1) ~ "Employment/investments",
  if_all(oe1_1:oe1_5, ~. == 2) & if_any(oe1_6:oe1_19, ~. == 1) ~ "Other"
))
data_clean %<>% select(-contains("oe1_"))

# Combining positive activities outside school into a single variable and removing individual variables
data_clean %<>% mutate(dv_pos_act = rowSums(across(m84:m101)))
data_clean %<>% select(-(m84:m101))

# Combining alcohol consumption in the last week into a single variable and removing individual variables
data_clean %<>% mutate(dv_alcohol = case_when(
  if_any(hd5_1:hd5_7, ~. == 1) ~ 1,
  hd5_8 == 1 ~ 0
))
data_clean %<>% select(-contains("hd5_"))

# Combining accidents and assaults into a single variable and removing individual variables
data_clean %<>% mutate(dv_accidents = case_when(
  b960539 == 1 ~ 0L,
  b960540 > 0 ~ as.integer(b960540)
))
data_clean %<>% select(-b960539, -b960540)

# Combining hospital admissions into a single variable and removing individual variables
data_clean %<>% mutate(dv_hospital = case_when(
  hospital == 1 ~ numadmn,
  hospital == 2 ~ 0
))
data_clean %<>% select(-hospital, -numadmn)

# Combining apprenticeships and work-related training into a single variable and removing individual variables
data_clean %<>% mutate(dv_training = case_when(
  if_any(c("aptrain", "wrktrain"), ~. == 1) ~ 1,
  if_all(c("aptrain", "wrktrain"), ~. == 2) ~ 0
))
data_clean %<>% select(-aptrain, -wrktrain)

# Recoding car ownership as a binary factor variable
data_clean %<>% mutate(B9SCQ19 = case_when(
  B9SCQ19 > 1 ~ 1,
  B9SCQ19 == 1 ~ 0
))

# Combining response outcome variables into a single binary variable and removing individual variables
data_clean %<>% mutate(dv_participation = case_when(
  if_all(contains("OUTCME"), ~. == 1) ~ 1,
  if_any(contains("OUTCME"), ~. != 1) ~ 0
))
data_clean %<>% select(-contains("OUTCME"))

# Combining organisation membership into a single variable and removing individual variables
data_clean %<>% mutate(dv_organisations = case_when(
  if_any(B9SCQ8A:B9SCQ8O, ~. == 1) ~ 1,
  B9SCQ8P == 1 ~ 0
))
data_clean %<>% select(-(B9SCQ8A:B9SCQ8P))

# Combining marital status items into a single variable and removing individual variables
data_clean %<>% mutate(dv_marital = case_when(
  B9MARCHK == 1 | B9HMS %in% c(2, 5) ~ "Married/CP",
  B9DIVCHK == 1 | B9HMS %in% c(1, 3, 4, 6, 7) ~ "Divorced/Separated/Widowed",
  B9HMS == 8 ~ "Single"
))
data_clean %<>% select(-B9DIVCHK, -B9HMS, -B9MARCHK)

# Recoding housing tenure at age 42
data_clean %<>% mutate(B9TEN = case_when(
  B9TEN %in% c(1, 2) ~ "Owned",
  B9TEN %in% c(3, 4, 5, 7) ~ "Not owned"
))

# Recoding labelled variables as factors, taking the values of the data labels
data_clean[c("a0014", "a0043b", "a0255", "e216a", "BDSTYPE", "B9TEN", "ameni", "brfed", "crowd", "resmove", "tenure", "fclrg90", "dv_sc_age_5", "dv_sc_age_16", "dv_incsource", "dv_marital")] %<>% as_factor(., only_labelled = FALSE)

# Removing Stata-format data labels which are incompatible with further cleaning and analysis steps
data_clean %<>% zap_labels(.)

# Recoding "yes/no" variables as binary variables taking values 0 (for "no") and 1 (for "yes")
data_clean %<>% mutate_at(
  c("emosup", "vote97", "B9SCQ17"),
  ~ recode(., `2` = 0L, `1` = 1L)
)
data_clean %<>% mutate_at(
  c("d016a", "rd6m_1"),
  ~ recode(., `1` = 0L, `2` = 1L)
)
```

## Exporting data
Finally, we can export the cleaned dataset for future use.

```{r export_clean_data}
fwrite(data_clean, ".\\Cleaned\\data_clean.csv")
```
