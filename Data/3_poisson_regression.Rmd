---
title: "3_poisson_regression"
author: "Thomas E. Metherell"
date: "2023-01-05"
output: html_document
---

Script in series: "Associations between early life mental health indicators and sleep in adulthood"

This script performs multiple imputation and Poisson regression analyses associated with this project.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Dependencies
We start by loading the necessary dependencies.

```{r dependencies}
library(data.table)
library(tidyverse)
library(magrittr)
library(parallel)
library(mice)
library(lmtest)
library(sandwich)
library(nnet)
```

## Loading the data
We now load the cleaned BCS70 data.

```{r load_data}
data_merged <- fread(".\\Cleaned\\data_clean.csv") %>% data.frame(.)
```

## Performing multiple imputation
We can now use the `mice` package to create multiple imputed datasets from the `data_merged` data frame, which contains missing data.

```{r mi}
# Establishing a cluster for parallel computation to save time
cl <- makeCluster(detectCores())

# Setting random seed
clusterSetRNGStream(cl, 1858)

# Making the data frame visible in the cluster environment
clusterExport(cl, "data_merged")

# Loading the mice package in the cluster environment
clusterEvalQ(cl, library(mice))

# Running multiple imputation with 10 imputations per core used and a maximum of 10 iterations
## This code was run with 8 cores and therefore there are 80 imputations in total
imp_pars <-
  parLapply(cl = cl, X = 1:detectCores(), fun = function(no){
    mice(data_merged, m = 10, maxit = 10, printFlag = FALSE)
  })
stopCluster(cl)

# Merging imputations into a single mids object 
imp_merged <- imp_pars[[1]]
for(i in 2:length(imp_pars)){
  imp_merged <- mice::ibind(imp_merged, imp_pars[[i]])
}
```

## Regression
We can now perform the regression analyses.

```{r regression}
#######
# Function : pois_regr
# Input : formula, a string containing a formula which describes the dependent and independent variables in the form "dep ~ ind1 + ind2 + ind3 + ..."
# Method : The function fits a modified Poisson regression model to the multiply imputed data according to the specified formula, obtains the risk ratio, confidence intervals and p-values from the model and binds these into a data frame
# Output : A data frame containing the risk ratios, confidence intervals and p-values obtained from a modified Poisson regression of the specified independent variables against the dependent variable
#######
pois_regr <- function(formula){
  suppressWarnings({
    model_fit <- with(imp_merged, coeftest(glm(as.formula(formula), family = poisson(link = "log"))), vcov. = sandwich)
    results <- summary(pool(model_fit))
    
    term <- results[, 1]
    RR <- round(exp(results[, 2]), 3)
    LCI <- round(exp(results[, 2] + qnorm(0.05/2)*results[, 3]), 3)
    UCI <- round(exp(results[, 2] - qnorm(0.05/2)*results[, 3]), 3)
    P <- round(results[, 6], 3)
    
    results_frame <- data.frame(term, RR, LCI, UCI, P)
    
    return(results_frame)
  })
}

#######
# Function : multinom_regr
# Input : formula, a string containing a formula which describes the dependent and independent variables in the form "dep ~ ind1 + ind2 + ind3 + ...". The dependent variable must be a factor
# Method : The function fits a multinomial logistic regression model to the multiply imputed data according to the specified formula, obtains the relative risk ratios, confidence intervals and p-values from the model and binds these into a data frame
# Output : A data frame containing the relative risk ratios, confidence intervals and p-values obtained from a multinomial regression of the specified independent variables against the dependent variable
#######
multinom_regr <- function(formula){
  model_fit <- with(imp_merged, multinom(as.formula(formula)))
  results <- summary(pool(model_fit))
  
  group <- results$lev[-1]
  RRR <- round(exp(results$coefficients[, 2]), 3)
  LCI <- round(exp(results$coefficients[, 2] + qnorm(0.05/2)*results$standard.errors[, 2]), 3)
  UCI <- round(exp(results$coefficients[, 2] - qnorm(0.05/2)*results$standard.errors[, 2]), 3)
  P <- round((1 - pnorm(abs(results$coefficients[, 2]/results$standard.errors[, 2]), 0, 1)) * 2, 3)
  
  results_frame <- data.frame(group, RRR, LCI, UCI, P)
  
  return(results_frame)
}

# Performing regressions against abnormal sleep

# Rutter (age 5)
rutter_5 <- pois_regr("dv_sr_sleep_abn ~ d119 + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + tenure + prmnh + crowd + ameni + brfed")
rutter_5_multi <- multinom_regr("dv_sr_sleep_abn_cat ~ d119 + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + tenure + prmnh + crowd + ameni + brfed")

print(rutter_5)
print(rutter_5_multi)

# Rutter (age 10)
rutter_10 <- pois_regr("dv_sr_sleep_abn ~ BD3MRUTT + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + bmi + fclrg90 + tenure + sepmumbcs + prmnh + crowd + ameni + brfed + resmove")
rutter_10_multi <- multinom_regr("dv_sr_sleep_abn_cat ~ BD3MRUTT + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + bmi + fclrg90 + tenure + sepmumbcs + prmnh + crowd + ameni + brfed + resmove")

print(rutter_10)
print(rutter_10_multi)

# Child Development Scale
cds <- pois_regr("dv_sr_sleep_abn ~ dv_cds_10 + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + bmi + fclrg90 + tenure + sepmumbcs + prmnh + crowd + ameni + brfed + resmove")
cds_multi <- multinom_regr("dv_sr_sleep_abn_cat ~ dv_cds_10 + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + bmi + fclrg90 + tenure + sepmumbcs + prmnh + crowd + ameni + brfed + resmove")

print(cds)
print(cds_multi)

# Malaise Inventory
malaise <- pois_regr("dv_sr_sleep_abn ~ BD4MAL + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + dv_bas_g + dv_med_10 + dv_sc_age_16 + bmi + fclrg90 + tenure + divorce + sepmumbcs + prmnh + crowd + ameni + brfed + resmove")
malaise_multi <- multinom_regr("dv_sr_sleep_abn_cat ~ BD4MAL + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + dv_bas_g + dv_med_10 + dv_sc_age_16 + bmi + fclrg90 + tenure + divorce + sepmumbcs + prmnh + crowd + ameni + brfed + resmove")

print(malaise)
print(malaise_multi)

# Behavioural or emotional problems
beh_emo <- pois_regr("dv_sr_sleep_abn ~ rd6m_1 + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + dv_bas_g + dv_med_10 + dv_sc_age_16 + bmi + fclrg90 + tenure + divorce + sepmumbcs + prmnh + crowd + ameni + brfed + resmove")
beh_emo_multi <- multinom_regr("dv_sr_sleep_abn_cat ~ rd6m_1 + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + dv_bas_g + dv_med_10 + dv_sc_age_16 + bmi + fclrg90 + tenure + divorce + sepmumbcs + prmnh + crowd + ameni + brfed + resmove")

print(beh_emo)
print(beh_emo_multi)

# Internalising behaviour in childhood
int_beh <- pois_regr("dv_sr_sleep_abn ~ intbcsz + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + dv_bas_g + dv_med_10 + dv_sc_age_16 + bmi + fclrg90 + tenure + divorce + sepmumbcs + prmnh + crowd + ameni + brfed + resmove")
int_beh_multi <- multinom_regr("dv_sr_sleep_abn_cat ~ intbcsz + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + dv_bas_g + dv_med_10 + dv_sc_age_16 + bmi + fclrg90 + tenure + divorce + sepmumbcs + prmnh + crowd + ameni + brfed + resmove")

print(int_beh)
print(int_beh_multi)

# Externalising behaviour in childhood
ext_beh <- pois_regr("dv_sr_sleep_abn ~ extbcsz + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + dv_bas_g + dv_med_10 + dv_sc_age_16 + bmi + fclrg90 + tenure + divorce + sepmumbcs + prmnh + crowd + ameni + brfed + resmove")
ext_beh_multi <- multinom_regr("dv_sr_sleep_abn_cat ~ extbcsz + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + dv_bas_g + dv_med_10 + dv_sc_age_16 + bmi + fclrg90 + tenure + divorce + sepmumbcs + prmnh + crowd + ameni + brfed + resmove")

print(ext_beh)
print(ext_beh_multi)
```