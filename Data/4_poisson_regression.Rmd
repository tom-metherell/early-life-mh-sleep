---
title: "4_poisson_regression"
author: "Thomas E. Metherell"
date: "2023-01-05"
output: html_document
---

Script in series: "Associations between early life mental health indicators and sleep in adulthood"

This script performs multiple imputation and Poisson regression analyses associated with this project.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Dependencies
We start by loading the necessary dependencies.

```{r dependencies}
library(data.table)
library(tidyverse)
library(magrittr)
library(parallel)
library(mice)
library(lmtest)
library(sandwich)
library(nnet)
```

## Loading the data
We now load the cleaned BCS70 data and prepare them for multiple imputation.

```{r load_data}
data_merged <- fread(".\\Cleaned\\data_clean.csv")

# Replacing blank values in character vectors with NA
is.na(data_merged[,]) <- data_merged[,] == ""

# Linearly rescaling all numeric variables to between 0 and 1 to aid regression model convergence
data_merged %<>% mutate_if(is.numeric, function(x) (x - min(x, na.rm = TRUE))/(max(x, na.rm = TRUE) - min(x, na.rm = TRUE)))

# Listing dependent variables for Poisson and multinomial logistic regression, respectively
pois_list <- c("dv_sd_sleepdur_abn", "dv_pal_sleepdur_abn", "dv_vdb_sleepdur_abn", "dv_winkler_sleepdur_abn")
multinom_list <- c("dv_sd_sleepdur_abn_cat", "dv_pal_sleepdur_abn_cat", "dv_vdb_sleepdur_abn_cat", "dv_winkler_sleepdur_abn_cat")

# Making "normal" the reference category for multinomial regression variables
data_merged[, multinom_list] %<>% as_factor() %>% relevel("Normal")
```

## Performing multiple imputation
We can now use the `mice` package to create multiple imputed datasets from the `data_merged` data frame, which contains missing data.

```{r mi}
# Establishing a cluster for parallel computation to save time
## NB: THIS SECTION IS CURRENTLY SET TO CREATE AS MANY NODES AS THERE ARE CPU CORES AVAILABLE. THIS MAY CAUSE PROBLEMS IF THERE ARE OTHER TASKS RUNNING SIMULTANEOUSLY
### if you need to reduce the number, substitute `detectCores()` with e.g. `detectCores() - 2` or `6` in BOTH appearances below
cl <- makeCluster(detectCores())

# Setting random seed
clusterSetRNGStream(cl, 1858)

# Making the data frame visible in the cluster environment
clusterExport(cl, "data_merged")

# Loading the mice package in the cluster environment
clusterEvalQ(cl, library(mice))

# Running multiple imputation with 1 imputation per core used and a maximum of 10 iterations
## This code was run with 8 cores and therefore there are 8 imputations in total
imp_pars <-
  parLapply(cl = cl, X = 1:detectCores(), fun = function(no){
    mice(data_merged, m = 1, maxit = 10, printFlag = FALSE)
  })
stopCluster(cl)

# Merging imputations into a single mids object 
imp_merged <- imp_pars[[1]]
for(i in 2:length(imp_pars)){
  imp_merged <- mice::ibind(imp_merged, imp_pars[[i]])
}

# Plotting trace lines to verify convergence
plot(imp_merged)
```

## Regression
We can now perform the regression analyses.

```{r regression}
#######
# Function : pois_regr
# Input : ind_vars, a string containing a formula which describes the independent variables in the form "ind1 + ind2 + ind3 + ..." and var_of_interest, a string containing the variable of interest (e.g. "ind1")
# Method : The function fits modified Poisson regression models to the multiply imputed data using each of the dependent variables in turn and the specified independent variables, obtains the risk ratios, confidence intervals and p-values for the variable of interest from the model and binds these into a data frame
# Output : A data frame containing the risk ratios, confidence intervals and p-values obtained from modified Poisson regressions of the specified independent variable against the dependent variables, controlling for the other independent variables
#######
pois_regr <- function(ind_vars, var_of_interest){
  suppressWarnings({
    poisson_regression <- function(dep_var, ind_vars, var_of_interest){
      model_fit <- with(imp_merged, coeftest(glm(as.formula(paste(dep_var, "~", ind_vars)), family = poisson(link = "log"))), vcov. = sandwich)
      results <- summary(pool(model_fit))
      
      ind_var <- var_of_interest
      RR <- round(exp(results[results$term == var_of_interest,]$estimate), 3)
      LCI <- round(exp(results[results$term == var_of_interest,]$estimate + qnorm(0.05/2)*results[results$term == var_of_interest,]$std.error), 3)
      UCI <- round(exp(results[results$term == var_of_interest,]$estimate - qnorm(0.05/2)*results[results$term == var_of_interest,]$std.error), 3)
      P <- round(results[results$term == var_of_interest,]$p.value, 3)
      
      results_frame <- data.frame(dep_var, ind_var, RR, LCI, UCI, P)
      
      return(results_frame)
    }
    
    results <- lapply(pois_list, function(X) poisson_regression(X, ind_vars, var_of_interest)) %>% reduce(rbind)

    return(results)
  })
}

#######
# Function : multinom_regr
# Input : ind_vars, a string containing a formula which describes the independent variables in the form "ind1 + ind2 + ind3 + ..." (the dependent variable must be a factor) and var_of_interest, a string containing the variable of interest (e.g. "ind1")
# Method : The function fits multinomial logistic regression models to the multiply imputed data using each of the dependent variables in turn and the specified independent variables, obtains the relative risk ratios, confidence intervals and p-values for the variable of interest from the model and binds these into a data frame
# Output : A data frame containing the relative risk ratios, confidence intervals and p-values obtained from multinomial regressions of the specified independent variable against the dependent variable, controlling for the other independent variables
#######
multinom_regr <- function(ind_vars, var_of_interest){
  multinomial_regression <- function(dep_var, ind_vars, var_of_interest){
    model_fit <- with(imp_merged, multinom(as.formula(paste(dep_var, "~", ind_vars)), maxit = 200))
    results <- summary(pool(model_fit))
    
    ind_var <- var_of_interest
    group <- results[results$term == var_of_interest,]$y.level
    RRR <- round(exp(results[results$term == var_of_interest,]$estimate), 3)
    LCI <- round(exp(results[results$term == var_of_interest,]$estimate + qnorm(0.05/2)*results[results$term == var_of_interest,]$std.error), 3)  
    UCI <- round(exp(results[results$term == var_of_interest,]$estimate - qnorm(0.05/2)*results[results$term == var_of_interest,]$std.error), 3)  
    P <- round(results[results$term == var_of_interest,]$p.value, 3)
  
    results_frame <- data.frame(dep_var, ind_var, group, RRR, LCI, UCI, P)
      
    return(results_frame)
  }
  
  results <- lapply(multinom_list, function(X) multinomial_regression(X, ind_vars, var_of_interest)) %>% reduce(rbind)
  
  return(results)
}

# Performing regressions against abnormal sleep

# Rutter (age 5)
rutter_5 <- pois_regr("d119 + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + tenure + prmnh + crowd + ameni + brfed", "d119")
rutter_5_multi <- multinom_regr("d119 + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + tenure + prmnh + crowd + ameni + brfed", "d119")

print(rutter_5)
print(rutter_5_multi)

# Rutter (age 10)
rutter_10 <- pois_regr("BD3MRUTT + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + bmi + fclrg90 + tenure + sepmumbcs + prmnh + crowd + ameni + brfed + resmove", "BD3MRUTT")
rutter_10_multi <- multinom_regr("BD3MRUTT + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + bmi + fclrg90 + tenure + sepmumbcs + prmnh + crowd + ameni + brfed + resmove", "BD3MRUTT")

print(rutter_10)
print(rutter_10_multi)

# Child Development Scale
cds <- pois_regr("dv_cds_10 + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + bmi + fclrg90 + tenure + sepmumbcs + prmnh + crowd + ameni + brfed + resmove", "dv_cds_10")
cds_multi <- multinom_regr("dv_cds_10 + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + bmi + fclrg90 + tenure + sepmumbcs + prmnh + crowd + ameni + brfed + resmove", "dv_cds_10")

print(cds)
print(cds_multi)

# Malaise Inventory
malaise <- pois_regr("BD4MAL + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + dv_bas_g + dv_med_10 + dv_sc_age_16 + bmi + fclrg90 + tenure + divorce + sepmumbcs + prmnh + crowd + ameni + brfed + resmove", "BD4MAL")
malaise_multi <- multinom_regr("BD4MAL + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + dv_bas_g + dv_med_10 + dv_sc_age_16 + bmi + fclrg90 + tenure + divorce + sepmumbcs + prmnh + crowd + ameni + brfed + resmove", "BD4MAL")

print(malaise)
print(malaise_multi)

# Behavioural or emotional problems
beh_emo <- pois_regr("rd6m_1 + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + dv_bas_g + dv_med_10 + dv_sc_age_16 + bmi + fclrg90 + tenure + divorce + sepmumbcs + prmnh + crowd + ameni + brfed + resmove", "rd6m_1")
beh_emo_multi <- multinom_regr("rd6m_1 + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + dv_bas_g + dv_med_10 + dv_sc_age_16 + bmi + fclrg90 + tenure + divorce + sepmumbcs + prmnh + crowd + ameni + brfed + resmove", "rd6m_1")

print(beh_emo)
print(beh_emo_multi)

# Internalising behaviour in childhood
int_beh <- pois_regr("intbcsz + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + dv_bas_g + dv_med_10 + dv_sc_age_16 + bmi + fclrg90 + tenure + divorce + sepmumbcs + prmnh + crowd + ameni + brfed + resmove", "intbcsz")
int_beh_multi <- multinom_regr("intbcsz + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + dv_bas_g + dv_med_10 + dv_sc_age_16 + bmi + fclrg90 + tenure + divorce + sepmumbcs + prmnh + crowd + ameni + brfed + resmove", "intbcsz")

print(int_beh)
print(int_beh_multi)

# Externalising behaviour in childhood
ext_beh <- pois_regr("extbcsz + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + dv_bas_g + dv_med_10 + dv_sc_age_16 + bmi + fclrg90 + tenure + divorce + sepmumbcs + prmnh + crowd + ameni + brfed + resmove", "extbcsz")
ext_beh_multi <- multinom_regr("extbcsz + a0005a + a0043b + a0195a + a0278 + dv_sc_birth + dv_par_edu_birth + dv_sc_age_5 + e216a + dv_cog_abil_5 + dv_med_5 + d016a + dv_bas_g + dv_med_10 + dv_sc_age_16 + bmi + fclrg90 + tenure + divorce + sepmumbcs + prmnh + crowd + ameni + brfed + resmove", "extbcsz")

print(ext_beh)
print(ext_beh_multi)
```